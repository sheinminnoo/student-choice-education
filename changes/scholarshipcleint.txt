"use client";

import { useMemo, useState } from "react";
import Image from "next/image";
import Link from "next/link";
import { motion } from "framer-motion";
import {
  scholarships,
  scholarshipCountries,
  type ScholarshipCountry,
  type StudyLevel,
  type ScholarshipFundingType,
} from "@/data/scholarships";

const MAX_WIDTH = "mx-auto max-w-7xl px-4 sm:px-6 lg:px-8";
const PAGE_SIZE = 6;

const studyLevelOptions: (StudyLevel | "All study levels")[] = [
  "All study levels",
  "Foundation",
  "Undergraduate",
  "Postgraduate",
  "MBA",
];

const fundingTypeOptions: (ScholarshipFundingType | "All funding types")[] = [
  "All funding types",
  "fee-discount",
  "tuition-waiver",
  "bursary",
  "living-cost-support",
];

type CountryFilter = ScholarshipCountry | "All countries";
type StudyLevelFilter = StudyLevel | "All study levels";
type FundingTypeFilter = ScholarshipFundingType | "All funding types";

export default function ScholarshipsPage() {
  const [country, setCountry] = useState<CountryFilter>("All countries");
  const [studyLevel, setStudyLevel] =
    useState<StudyLevelFilter>("All study levels");
  const [fundingType, setFundingType] =
    useState<FundingTypeFilter>("All funding types");
  const [autoOnly, setAutoOnly] = useState(false);
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);

  const filtered = useMemo(() => {
    return scholarships
      .filter((s) => {
        if (country !== "All countries" && s.country !== country) return false;
        if (
          studyLevel !== "All study levels" &&
          !s.studyLevels.includes(studyLevel)
        )
          return false;
        if (
          fundingType !== "All funding types" &&
          s.fundingType !== fundingType
        )
          return false;
        if (autoOnly && !s.automaticConsideration) return false;
        if (!search.trim()) return true;
        const q = search.toLowerCase();
        return (
          s.universityName.toLowerCase().includes(q) ||
          s.name.toLowerCase().includes(q) ||
          s.campusLabel.toLowerCase().includes(q)
        );
      })
      .sort((a, b) => {
        if (a.country === b.country) {
          return a.universityName.localeCompare(b.universityName);
        }
        return a.country.localeCompare(b.country);
      });
  }, [country, studyLevel, fundingType, autoOnly, search]);

  const totalCountries = new Set(scholarships.map((s) => s.country)).size;
  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));

  const startIndex = (page - 1) * PAGE_SIZE;
  const visible = filtered.slice(startIndex, startIndex + PAGE_SIZE);

  const smoothScrollToList = () => {
    if (typeof window === "undefined") return;
    const el = document.getElementById("scholarship-list-start");
    if (!el) return;

    const rect = el.getBoundingClientRect();
    const offset = window.scrollY + rect.top - 120; // keep filters in view
    window.scrollTo({ top: offset, behavior: "smooth" });
  };

  const goToPage = (nextPage: number) => {
    setPage(nextPage);
    smoothScrollToList();
  };

  const resetToFirstPage = () => {
    setPage(1);
    smoothScrollToList();
  };

  return (
    <main className="min-h-screen bg-white text-[#020b2c]">
      {/* ========== HERO ========== */}
      <section className="relative overflow-hidden border-b border-slate-200">
        {/* Full-width background image */}
        <div className="absolute inset-0">
          <Image
            src="/heros/scholarship-hero.png"
            alt="Students discussing scholarships and study plans"
            fill
            priority
            sizes="100vw"
            className="object-cover brightness-[0.75] contrast-[1.05]"
          />

          {/* Premium dark soft overlay */}
          <div className="absolute inset-0 bg-gradient-to-r from-[#020b2c]/85 via-[#020b2c]/65 to-[#020b2c]/30" />

          {/* Soft yellow brand glow */}
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(250,204,21,0.18)_0,_transparent_60%)]" />
        </div>

        <div
          className={`${MAX_WIDTH} relative pt-14 pb-12 sm:pt-18 sm:pb-14 lg:pt-20 lg:pb-16`}
        >
          <div className="max-w-3xl space-y-6">
            <motion.p
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.4, ease: "easeOut" }}
              className="inline-flex items-center gap-2 rounded-full border border-yellow-400/60 bg-[#020b2c]/80 px-4 py-1.5 text-xs font-semibold uppercase tracking-[0.16em] text-yellow-300 shadow-sm backdrop-blur"
            >
              Scholarships hub
              <span className="h-1 w-1 rounded-full bg-yellow-400" />
              Verified university support
            </motion.p>

            <motion.h1
              initial={{ opacity: 0, y: 14 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, ease: "easeOut", delay: 0.05 }}
              className="text-balance text-3xl font-semibold tracking-tight text-white sm:text-4xl lg:text-5xl"
            >
              Discover{" "}
              <span className="bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-400 bg-clip-text text-transparent">
                real scholarships
              </span>{" "}
              for your UK and EU study journey.
            </motion.h1>

            <motion.p
              initial={{ opacity: 0, y: 12 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, ease: "easeOut", delay: 0.1 }}
              className="max-w-xl text-sm leading-relaxed text-slate-200 sm:text-base"
            >
              Browse curated fee discounts, bursaries and funding offers from
              trusted universities. Use filters to match by country, study level
              and funding type, then open the detail page to check full
              conditions.
            </motion.p>

            <motion.div
              initial={{ opacity: 0, y: 12 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, ease: "easeOut", delay: 0.14 }}
              className="flex flex-wrap gap-3 text-xs"
            >
              <div className="inline-flex items-center gap-2 rounded-2xl border border-white/20 bg-white/90 px-4 py-2 shadow-sm backdrop-blur">
                <div className="h-2 w-2 rounded-full bg-yellow-400" />
                <div>
                  <p className="text-[11px] uppercase tracking-[0.16em] text-slate-500">
                    Scholarships listed
                  </p>
                  <p className="text-sm font-semibold text-[#020b2c]">
                    {scholarships.length} active schemes
                  </p>
                </div>
              </div>

              <div className="inline-flex items-center gap-2 rounded-2xl border border-white/20 bg-white/90 px-4 py-2 shadow-sm backdrop-blur">
                <div className="h-2 w-2 rounded-full bg-yellow-400" />
                <div>
                  <p className="text-[11px] uppercase tracking-[0.16em] text-slate-500">
                    Countries covered
                  </p>
                  <p className="text-sm font-semibold text-[#020b2c]">
                    {totalCountries}+ destinations
                  </p>
                </div>
              </div>
            </motion.div>
          </div>
        </div>
      </section>

      {/* ========== FILTER BAR + LIST ========== */}
      <section className={`${MAX_WIDTH} space-y-8 py-8 sm:py-10 lg:py-12`}>
        {/* Premium filter bar (NO card design) */}
        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.45, ease: "easeOut" }}
          className="space-y-4 border-b border-slate-200 pb-5"
        >
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p className="text-xs font-semibold uppercase tracking-[0.16em] text-slate-500">
                Filter scholarships
              </p>
              <p className="mt-1 text-xs text-slate-600">
                Adjust the filters below, then scroll the list to explore
                scholarships that fit your plan.
              </p>
            </div>
            <p className="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-[11px] text-slate-700">
              Showing{" "}
              <span className="font-semibold text-[#020b2c]">
                {filtered.length}
              </span>{" "}
              result{filtered.length === 1 ? "" : "s"}
            </p>
          </div>

          <div className="space-y-4">
            {/* Search */}
            <div className="relative">
              <input
                value={search}
                onChange={(e) => {
                  setSearch(e.target.value);
                  resetToFirstPage();
                }}
                placeholder="Search by university, campus or scholarship name"
                className="w-full rounded-2xl border border-slate-200 bg-white px-3.5 py-2.5 pr-10 text-sm text-[#020b2c] placeholder:text-slate-400 focus:border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-300/70"
              />
              <span className="pointer-events-none absolute inset-y-0 right-3 flex items-center text-xs text-slate-400">
                ⌕
              </span>
            </div>

            {/* Main filter rows */}
            <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
              {/* Country filter */}
              <div className="space-y-1.5">
                <div className="flex flex-wrap gap-1.5">
                  <button
                    type="button"
                    onClick={() => {
                      setCountry("All countries");
                      resetToFirstPage();
                    }}
                    className={`rounded-full px-3 py-1.5 text-xs font-medium ${
                      country === "All countries"
                        ? "bg-[#020b2c] text-white"
                        : "border border-slate-200 bg-white text-[#020b2c] hover:border-yellow-400"
                    }`}
                  >
                    All
                  </button>
                  {scholarshipCountries.map((c) => (
                    <button
                      key={c}
                      type="button"
                      onClick={() => {
                        setCountry(c);
                        resetToFirstPage();
                      }}
                      className={`rounded-full px-3 py-1.5 text-xs font-medium capitalize ${
                        country === c
                          ? "bg-yellow-400 text-[#020b2c]"
                          : "border border-slate-200 bg-white text-[#020b2c] hover:border-yellow-400"
                      }`}
                    >
                      {c.toLowerCase()}
                    </button>
                  ))}
                </div>
              </div>

              {/* Study level filter */}
              <div className="space-y-1.5">
                <select
                  value={studyLevel}
                  onChange={(e) => {
                    setStudyLevel(e.target.value as StudyLevelFilter);
                    resetToFirstPage();
                  }}
                  className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-xs font-medium text-[#020b2c] focus:border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-300/70"
                >
                  {studyLevelOptions.map((lvl) => (
                    <option key={lvl} value={lvl}>
                      {lvl === "All study levels" ? "All study levels" : lvl}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-3 sm:grid-cols-[minmax(0,1.4fr)_minmax(0,1fr)]">
              {/* Funding type filter */}
              <div className="space-y-1.5">
                <select
                  value={fundingType}
                  onChange={(e) => {
                    setFundingType(e.target.value as FundingTypeFilter);
                    resetToFirstPage();
                  }}
                  className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-xs font-medium text-[#020b2c] focus:border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-300/70"
                >
                  {fundingTypeOptions.map((t) => (
                    <option key={t} value={t}>
                      {t === "All funding types" ? "All funding types" : t}
                    </option>
                  ))}
                </select>
              </div>

              {/* Automatic toggle */}
              <button
                type="button"
                onClick={() => {
                  setAutoOnly((v) => !v);
                  resetToFirstPage();
                }}
                className={`mt-5 flex items-center justify-between rounded-2xl border px-3.5 py-2.5 text-xs font-medium transition ${
                  autoOnly
                    ? "border-yellow-400 text-[#020b2c] bg-yellow-50"
                    : "border-slate-200 text-slate-700 bg-white hover:border-yellow-400"
                }`}
              >
                <span>Show only automatic scholarships</span>
                <span
                  className={`inline-flex h-4 w-7 items-center rounded-full border ${
                    autoOnly
                      ? "border-yellow-400 bg-yellow-400"
                      : "border-slate-300 bg-slate-100"
                  }`}
                >
                  <span
                    className={`h-3.5 w-3.5 rounded-full bg-white transition-transform ${
                      autoOnly ? "translate-x-3" : "translate-x-0.5"
                    }`}
                  />
                </span>
              </button>
            </div>
          </div>
        </motion.div>

        <div className="mt-3 flex flex-wrap items-center justify-between gap-3 text-[11px] text-slate-500">
          <p>
            All scholarships are subject to change. Always confirm on the
            official university page before making decisions.
          </p>
          <p>
            Page {page} of {totalPages}
          </p>
        </div>

        {/* ========== LIST + PAGINATION ========== */}
        <div id="scholarship-list-start" className="mt-6">
          {filtered.length === 0 ? (
            <div className="flex min-h-[200px] flex-col items-center justify-center rounded-3xl border border-dashed border-slate-200 bg-slate-50 px-6 py-10 text-center">
              <p className="text-sm font-medium text-[#020b2c]">
                No scholarships match your filters
              </p>
              <p className="mt-2 max-w-md text-xs text-slate-600">
                Try removing one of the filters or searching by a different
                university or campus name.
              </p>
            </div>
          ) : (
            <>
              <div className="space-y-6">
                {visible.map((s) => (
                  <motion.article
                    key={s.id}
                    initial={{ opacity: 0, y: 14 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    viewport={{ once: true, amount: 0.2 }}
                    transition={{ duration: 0.35, ease: "easeOut" }}
                  >
                    <Link
                      href={`/scholarships/${s.id}`}
                      className="group block overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-[0_18px_40px_rgba(15,23,42,0.06)] transition hover:shadow-[0_18px_60px_rgba(15,23,42,0.12)]"
                    >
                      <div className="grid grid-cols-1 md:grid-cols-2">
                        {/* LEFT IMAGE PANEL */}
                        <div className="relative">
                          <div className="relative h-56 w-full sm:h-64">
                            <Image
                              src={s.campusImage}
                              alt={`${s.universityName} campus`}
                              fill
                              sizes="(min-width: 1024px) 40vw, 100vw"
                              className="object-cover"
                            />
                          </div>

                          <div className="absolute inset-0 bg-[#020b2c]/50 opacity-0 transition group-hover:opacity-100" />
                          <div className="absolute inset-0 flex flex-col items-center justify-center gap-3 px-6 text-center text-white opacity-0 transition group-hover:opacity-100">
                            {s.universityLogo && (
                              <div className="relative h-14 w-14 overflow-hidden rounded-2xl bg-white">
                                <Image
                                  src={s.universityLogo}
                                  alt={`${s.universityName} logo`}
                                  fill
                                  sizes="56px"
                                  className="object-contain"
                                />
                              </div>
                            )}
                            <p className="text-[11px] font-semibold uppercase tracking-[0.16em] text-yellow-300">
                              {s.country} • {s.campusLabel}
                            </p>
                            <p className="max-w-xs text-sm font-semibold text-white">
                              {s.universityName}
                            </p>
                            {s.tagline && (
                              <p className="max-w-xs text-[11px] text-yellow-100/90">
                                {s.tagline}
                              </p>
                            )}
                          </div>
                        </div>

                        {/* RIGHT CONTENT PANEL */}
                        <div className="flex flex-col justify-center gap-4 p-6 sm:p-8">
                          <div className="space-y-2">
                            <p className="text-[11px] font-semibold uppercase tracking-[0.16em] text-slate-500">
                              {s.universityName}
                            </p>
                            <h2 className="text-lg font-semibold leading-snug text-[#020b2c]">
                              {s.name}
                            </h2>
                            <p className="mt-1 line-clamp-2 text-xs text-slate-700">
                              {s.typicalValueDescription}
                            </p>
                          </div>

                          <div className="flex flex-wrap items-center gap-2">
                            <div className="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-1.5">
                              <p className="text-[10px] uppercase tracking-[0.16em] text-slate-500">
                                Max value
                              </p>
                              <p className="text-xs font-semibold text-yellow-500">
                                {s.maxValue}
                              </p>
                            </div>

                            <div className="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-1.5">
                              <p className="text-[10px] uppercase tracking-[0.16em] text-slate-500">
                                Funding type
                              </p>
                              <p className="text-xs font-semibold capitalize text-[#020b2c]">
                                {s.fundingType.replace("-", " ")}
                              </p>
                            </div>

                            <div className="flex flex-wrap gap-1.5">
                              {s.studyLevels.map((lvl) => (
                                <span
                                  key={lvl}
                                  className="rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-[10px] font-medium text-[#020b2c]"
                                >
                                  {lvl}
                                </span>
                              ))}
                              {s.automaticConsideration ? (
                                <span className="rounded-full border border-yellow-400 bg-yellow-50 px-2.5 py-0.5 text-[10px] font-medium text-[#020b2c]">
                                  Automatic
                                </span>
                              ) : (
                                <span className="rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-[10px] font-medium text-slate-600">
                                  Application required
                                </span>
                              )}
                            </div>
                          </div>

                          <div className="mt-1 flex items-center justify-between border-t border-slate-200 pt-3">
                            <span className="text-[10px] text-slate-600">
                              Intakes: {s.mainIntakes.join(" • ")}
                            </span>
                            <span
                              className="
  inline-flex items-center gap-1.5 rounded-full 
  bg-[#F5C20B] text-[#020b2c]
  px-5 py-2 text-xs font-semibold 
  shadow-[0_4px_14px_rgba(245,194,11,0.35)]
  transition-all duration-300
  hover:bg-[#ffcf22]
  hover:shadow-[0_6px_20px_rgba(245,194,11,0.55)]
"
                            >
                              View details
                              <span className="text-sm">→</span>
                            </span>
                          </div>
                        </div>
                      </div>
                    </Link>
                  </motion.article>
                ))}
              </div>

              {totalPages > 1 && (
                <div className="mt-8 flex items-center justify-center gap-3">
                  <button
                    type="button"
                    disabled={page === 1}
                    onClick={() => goToPage(Math.max(1, page - 1))}
                    className={`rounded-full px-4 py-1.5 text-xs font-medium ${
                      page === 1
                        ? "cursor-not-allowed border border-slate-200 bg-slate-50 text-slate-400"
                        : "border border-slate-200 bg-white text-[#020b2c] hover:border-yellow-400"
                    }`}
                  >
                    Previous
                  </button>
                  <span className="text-[11px] text-slate-600">
                    Page {page} of {totalPages}
                  </span>
                  <button
                    type="button"
                    disabled={page === totalPages}
                    onClick={() => goToPage(Math.min(totalPages, page + 1))}
                    className={`rounded-full px-4 py-1.5 text-xs font-medium ${
                      page === totalPages
                        ? "cursor-not-allowed border border-slate-200 bg-slate-50 text-slate-400"
                        : "border border-slate-200 bg-white text-[#020b2c] hover:border-yellow-400"
                    }`}
                  >
                    Next
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      </section>
    </main>
  );
}
